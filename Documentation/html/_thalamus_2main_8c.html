<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>Mavrx Multirotor Firmware: Thalamus/main.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Mavrx Multirotor Firmware
   </div>
   <div id="projectbrief">Firmware for multirotors with Thalamus and Hypo</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('_thalamus_2main_8c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">main.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>It all starts here.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;all.h&quot;</code><br/>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a7dfd9b79bc5a37d7df40207afbc5431f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_thalamus_2main_8c.html#a7dfd9b79bc5a37d7df40207afbc5431f">setup</a> (void)</td></tr>
<tr class="memdesc:a7dfd9b79bc5a37d7df40207afbc5431f"><td class="mdescLeft">&#160;</td><td class="mdescRight">This is the setup function, sets everything up.  <a href="#a7dfd9b79bc5a37d7df40207afbc5431f">More...</a><br/></td></tr>
<tr class="separator:a7dfd9b79bc5a37d7df40207afbc5431f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0b33edabd7f1c4e4a0bf32c67269be2f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_thalamus_2main_8c.html#a0b33edabd7f1c4e4a0bf32c67269be2f">loop</a> (void)</td></tr>
<tr class="memdesc:a0b33edabd7f1c4e4a0bf32c67269be2f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Main loop (idle loop, doesn't do much)  <a href="#a0b33edabd7f1c4e4a0bf32c67269be2f">More...</a><br/></td></tr>
<tr class="separator:a0b33edabd7f1c4e4a0bf32c67269be2f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a00b1ff12603b34aaa42c7e91c7b59aa1"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_thalamus_2main_8c.html#a00b1ff12603b34aaa42c7e91c7b59aa1">SysTickInterrupt</a> (void)</td></tr>
<tr class="memdesc:a00b1ff12603b34aaa42c7e91c7b59aa1"><td class="mdescLeft">&#160;</td><td class="mdescRight">System Tick Timer, deals with timing, flashing, pushing.  <a href="#a00b1ff12603b34aaa42c7e91c7b59aa1">More...</a><br/></td></tr>
<tr class="separator:a00b1ff12603b34aaa42c7e91c7b59aa1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a85547937805d6281656f9b300156e86c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_thalamus_2main_8c.html#a85547937805d6281656f9b300156e86c">RITInterrupt</a> (void)</td></tr>
<tr class="memdesc:a85547937805d6281656f9b300156e86c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Repetitive Interrput Timer, deals with EEPROM parameters over ilink.  <a href="#a85547937805d6281656f9b300156e86c">More...</a><br/></td></tr>
<tr class="separator:a85547937805d6281656f9b300156e86c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a161486765abbb128852e09c6c618b998"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_thalamus_2main_8c.html#a161486765abbb128852e09c6c618b998">Timer0Interrupt0</a> (void)</td></tr>
<tr class="memdesc:a161486765abbb128852e09c6c618b998"><td class="mdescLeft">&#160;</td><td class="mdescRight">Main code loop, all the flight control stuff is in here.  <a href="#a161486765abbb128852e09c6c618b998">More...</a><br/></td></tr>
<tr class="separator:a161486765abbb128852e09c6c618b998"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>It all starts here. </p>
<p>On bootup, a startup function is run (part of the function library, and not documented in this code. The startuf function after initialising the hardware proceeds to invoke the function <a class="el" href="_beacon_2main_8c.html#a4fc01d736fe50cf5b977f755b675f11d" title="This is the setup function, sets everything up. ">setup()</a> followed by <a class="el" href="_beacon_2main_8c.html#afe461d27b9c48d5921c00d521181f12f" title="Main loop (idle loop, doesn&#39;t do much) ">loop()</a>.</p>
<p>This file contains <a class="el" href="_beacon_2main_8c.html#a4fc01d736fe50cf5b977f755b675f11d" title="This is the setup function, sets everything up. ">setup()</a> and <a class="el" href="_beacon_2main_8c.html#afe461d27b9c48d5921c00d521181f12f" title="Main loop (idle loop, doesn&#39;t do much) ">loop()</a>, as well as some of the interrupt service routines that are set to run repeatedly.</p>
<dl class="section author"><dt>Author</dt><dd>Yuan Gao </dd>
<dd>
Henry Fletcher </dd>
<dd>
Oskar Weigl</dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000016">Todo:</a></b></dt><dd>Diagnose loss of control experienced at full throttle. I ascended at full throttle while probably applying some pitch and roll demands and suddenly the craft just seemed to loose stability. It rolled/ pitched upside down a few times, luckily it recovered and I was able to bring it back safely. However, have heard that a backer had a similar problem. Possible causes are Yuan's Max throttle stuff, my roll angle prioritisation (less likely as wasn't in the backers code), ROLL/ PITCH SPL (spin limit). Or other! Have done some test flights and witnessed the loss of control at high throttles, it only does it when applying a high throttle and a large attitude demand, it inverts then enters a continual spin at high throttle Have added code on line 51 of <a class="el" href="control_8h_source.html">control.h</a> to try and solve this problem Rescues craft if error gets too large at high throttles by detecting roll and pitch error getting too large and reducing the throttle.</dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000017">Todo:</a></b></dt><dd>Test to see if this code solves the problem Tried this: if(((pitcherror &gt; 0.08) || (pitcherror &lt; -0.08) || (rollerror &gt; 0.08) || (rollerror &lt; -0.08)) &amp;&amp; (throttle &gt; 600)) throttle -= 200; Should really be able to solve with better PID tuning.}</dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000018">Todo:</a></b></dt><dd>check all integrators for decoupling, and make sure they are locked in this case</dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000019">Todo:</a></b></dt><dd>Assess and Improve leveling on take off and leveling in flight Key areas to investigate are integral gain on takeoff Accelerometer feedback gain Accelerometer feedback method - additional filtering needed? Landing Gear separation seems to play a large part, it causes undesired integral wind-up before the craft is in the air Landing gear would need switches or be sprung and damped with longish travel</dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000020">Todo:</a></b></dt><dd>Measure loop rates instead of just assuming it The control needs to know how fast they're going, right now we assume the loops are going at their specified rate however, it would be better to just time instead. Use one of the hardware timers to get sub-ms resolution.</dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000021">Todo:</a></b></dt><dd>Check for some discontinuities in flight Throttle and attitude blips when flying under GPS Throttle blips when flying normally</dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a0b33edabd7f1c4e4a0bf32c67269be2f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void loop </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Main loop (idle loop, doesn't do much) </p>
<p>This is the main loop, the processor sits in here when it's not dealing with interrupts. This loop's only purpose right now is to deal with button presses. </p>

</div>
</div>
<a class="anchor" id="a85547937805d6281656f9b300156e86c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void RITInterrupt </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Repetitive Interrput Timer, deals with EEPROM parameters over ilink. </p>
<p>This function is triggered by interrupt every few tens of ms (actual speed, is defined by MESSAGE_LOOP_HZ), its purpose is to shunt out EEPROM parameters over ilink to Hypo. </p>

</div>
</div>
<a class="anchor" id="a7dfd9b79bc5a37d7df40207afbc5431f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void setup </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This is the setup function, sets everything up. </p>
<p>This is the first user function called after the initialisation is complete. All the hardware peripherals and stuff are initialised here. </p>

</div>
</div>
<a class="anchor" id="a00b1ff12603b34aaa42c7e91c7b59aa1"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void SysTickInterrupt </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>System Tick Timer, deals with timing, flashing, pushing. </p>
<p>This function is triggered by interrupt every 1ms, its purpose is to keep timings, flash LEDs, and time button pushes. </p>

</div>
</div>
<a class="anchor" id="a161486765abbb128852e09c6c618b998"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void Timer0Interrupt0 </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Main code loop, all the flight control stuff is in here. </p>
<p>This function is triggered by interrupt from timer 0, should be about 400Hz, actual speed is defined by FAST_RATE. The function also contains a software postscaler to run a set of functions at a slower rate defined by SLOW_RATE</p>
<p>The functions called here are part of the main flight code. </p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_bfc07db8d2defe76e29ff476daeb588c.html">Thalamus</a></li><li class="navelem"><a class="el" href="_thalamus_2main_8c.html">main.c</a></li>
    <li class="footer">Generated on Thu Sep 12 2013 17:44:11 for Mavrx Multirotor Firmware by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>
